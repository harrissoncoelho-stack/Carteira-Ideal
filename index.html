<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora Avançada de Investimentos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f4f6f9; color: #333; padding: 20px; }
    h1 { text-align: center; color: #0077b6; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    label { display: block; margin: 10px 0 5px; }
    input, select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-bottom: 15px; }
    button { background-color: #0077b6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #005f87; }
    #resultado { margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: right; }
    th { background-color: #0077b6; color: white; }
  </style>
</head>
<body>

<h1>Calculadora Avançada de Investimentos</h1>

<div class="container">
  <label for="aporteInicial">Aporte Inicial (R$):</label>
  <input type="number" id="aporteInicial" placeholder="Ex: 1000">

  <label for="aporteMensal">Aporte Mensal (R$):</label>
  <input type="number" id="aporteMensal" placeholder="Ex: 500">

  <label for="anos">Tempo de Aplicação (anos):</label>
  <input type="number" id="anos" placeholder="Ex: 10">

  <label for="tipoTaxa">Tipo de Juros:</label>
  <select id="tipoTaxa">
    <option value="pre">Pré-fixada</option>
    <option value="pos">Pós-fixada</option>
    <option value="cdi">CDI</option>
    <option value="ipca">IPCA</option>
  </select>

  <label for="taxaJuros">Taxa de Juros (% ao ano):</label>
  <input type="number" id="taxaJuros" placeholder="Ex: 12">

  <label for="tipoTaxaCalc">Taxa calculada:</label>
  <select id="tipoTaxaCalc">
    <option value="ano">Anual</option>
    <option value="mes">Mensal</option>
  </select>

  <button onclick="calcularInvestimento()">Calcular</button>

  <div id="resultado">
    <canvas id="graficoInvestimento"></canvas>
    <div id="valoresAno" style="margin-top: 20px;"></div>
    <div id="resumoFinal" style="margin-top: 20px;"></div>
  </div>
</div>

<script>
async function obterTaxas() {
  try {
    const cdiResponse = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.12/dados?formato=json');
    const ipcaResponse = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados?formato=json');
    const cdiData = await cdiResponse.json();
    const ipcaData = await ipcaResponse.json();

    const cdiAtual = parseFloat(cdiData[cdiData.length - 1].valor.replace(',', '.')) / 100;
    const ipcaAtual = parseFloat(ipcaData[ipcaData.length - 1].valor.replace(',', '.')) / 100;

    return { cdiAtual, ipcaAtual };
  } catch (error) {
    console.error('Erro ao obter taxas:', error);
    return { cdiAtual: 0.149, ipcaAtual: 0.0315 };
  }
}

async function calcularInvestimento() {
  const aporteInicial = parseFloat(document.getElementById('aporteInicial').value) || 0;
  const aporteMensal = parseFloat(document.getElementById('aporteMensal').value) || 0;
  const anos = parseInt(document.getElementById('anos').value) || 0;
  const tipoTaxa = document.getElementById('tipoTaxa').value;
  let taxaJuros = parseFloat(document.getElementById('taxaJuros').value) / 100 || 0;
  const tipoCalc = document.getElementById('tipoTaxaCalc').value;

  if (tipoTaxa === 'cdi' || tipoTaxa === 'ipca') {
    const taxas = await obterTaxas();
    if (tipoTaxa === 'cdi') taxaJuros = taxas.cdiAtual;
    if (tipoTaxa === 'ipca') taxaJuros = taxas.ipcaAtual;
  }

  // Converter taxa anual para mensal para os cálculos de juros compostos
  const taxaMensal = Math.pow(1 + taxaJuros, 1 / 12) - 1;
  const totalMeses = anos * 12;

  let valoresMes = [];
  let totalInvestidoMes = aporteInicial;
  let valorFinal = aporteInicial;

  for (let i = 1; i <= totalMeses; i++) {
    valorFinal = valorFinal * (1 + taxaMensal) + aporteMensal;
    totalInvestidoMes += aporteMensal;
    if (i % 12 === 0) {
      valoresMes.push({ ano: i / 12, investido: totalInvestidoMes, total: valorFinal });
    }
  }

  // Criar tabela
  let divValores = document.getElementById('valoresAno');
  divValores.innerHTML = '<h3>Evolução do Investimento:</h3>';
  let tabela = '<table><tr><th>Ano</th><th>Total Investido (R$)</th><th>Valor Total com Rendimentos (R$)</th></tr>';
  valoresMes.forEach(v => {
    tabela += `<tr><td>${v.ano}</td><td>${v.investido.toLocaleString('pt-BR')}</td><td>${v.total.toLocaleString('pt-BR')}</td></tr>`;
  });
  tabela += '</table>';
  divValores.innerHTML += tabela;

  // Gráfico
  const ctx = document.getElementById('graficoInvestimento').getContext('2d');
  if (window.grafico) window.grafico.destroy();
  window.grafico = new Chart(ctx, {
    type: 'line',
    data: {
      labels: valoresMes.map(v => `Ano ${v.ano}`),
      datasets: [
        {
          label: 'Total Investido (R$)',
          data: valoresMes.map(v => v.investido),
          borderColor: '#0096c7',
          backgroundColor: 'rgba(0,150,199,0.2)',
          fill: false,
          tension: 0.3
        },
        {
          label: 'Valor Total com Rendimentos (R$)',
          data: valoresMes.map(v => v.total),
          borderColor: '#0077b6',
          backgroundColor: 'rgba(0,119,182,0.2)',
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true, position: 'top' },
        tooltip: {
          callbacks: {
            label: function (context) {
              return context.dataset.label + ': R$ ' + context.raw.toLocaleString('pt-BR');
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: value => 'R$ ' + value.toLocaleString('pt-BR') }
        }
      }
    }
  });

  // Resumo final
  const resumo = document.getElementById('resumoFinal');
  const totalGanho = valorFinal - totalInvestidoMes;
  const percentualGanho = ((totalGanho / totalInvestidoMes) * 100).toFixed(2);

  resumo.innerHTML = `<h3>Resumo Final:</h3>
      <p>Total Investido: R$ ${totalInvestidoMes.toLocaleString('pt-BR')}</p>
      <p>Valor Total com Rendimentos: R$ ${valorFinal.toLocaleString('pt-BR')}</p>
      <p>Ganho Total: R$ ${totalGanho.toLocaleString('pt-BR')} (${percentualGanho}%)</p>`;
}
</script>

</body>
</html>
